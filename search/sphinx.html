<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>Sphinx (search engine) 使用笔记 - </title>
    <meta name="keywords" content=""/>
    <meta name="description" content=""/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/">Home</a>&nbsp;&#187;&nbsp;<a href="/#search">search</a>&nbsp;&#187;&nbsp;Sphinx (search engine) 使用笔记
    <span class="updated">Updated&nbsp;
      2016-11-19 19:00
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">Sphinx (search engine) 使用笔记</div>

  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#sphinx">Sphinx 简介</a><ul>
<li><a href="#_1">部分同类开源产品</a></li>
<li><a href="#_2">基本原理</a></li>
<li><a href="#_3">部分功能</a></li>
<li><a href="#_4">中文支持</a></li>
<li><a href="#api">API 协议</a><ul>
<li><a href="#_5">请求</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<h1 id="sphinx">Sphinx 简介</h1>
<p><a href="http://sphinxsearch.com/">Sphinx</a> 是一个轻量级的全文检索引擎。</p>
<h2 id="_1">部分同类开源产品</h2>
<ul>
<li><a href="https://www.elastic.co/products/elasticsearch">Elasticsearch</a> 基于 Lucene 的开源搜索引擎，支持 RESTful API。</li>
<li><a href="https://github.com/huacnlee/redis-search">Redis-Search</a> 基于 Redis 的高效搜索组件。</li>
<li><a href="http://www.searchdaimon.com/">Searchdaimon ES</a> 一个针对公司数据和网站的搜索引擎。</li>
</ul>
<p>另外，Redis 的不稳定版已经支持<a href="http://antirez.com/news/106">加载外部模块</a>，<a href="https://github.com/RedisLabsModules/RediSearch">RediSearch</a> 就是一个全文检索的模块。以 Redis 社区的活跃程度，此类基于 Redis 模块方式的检索引擎应该会越来越成熟。</p>
<p>查看更多<a href="https://en.wikipedia.org/wiki/Full-text_search">同类产品</a>。</p>
<h2 id="_2">基本原理</h2>
<p>Sphinx 包含几个可执行程序：wordbreaker，indexer，searchd 等。</p>
<ul>
<li>
<p>wordbreaker 分词程序。</p>
</li>
<li>
<p>indexer 从数据源读取输入，分词，建立索引数据。</p>
</li>
<li>
<p>searchd 为客户端提供检索服务，解析请求，读取索引数据，返回结果给客户端。</p>
</li>
</ul>
<h2 id="_3">部分功能</h2>
<ul>
<li>支持的数据源：</li>
<li>MySQL, PostgreSQL, MS QL...</li>
<li>xmlpipe, xmlpipe2: 相比 xmlpipe，xmlpipe2 支持直接在 xml 内指定数据的 field 和 attr 等配置功能。</li>
<li>
<p>tsvpipe, csvpipe...</p>
</li>
<li>
<p>支持实时增加索引(RT 实时索引)，目前 RT 实时索引仅支持 SphinxQL 协议操作，不支持 API 方式。</p>
</li>
</ul>
<h2 id="_4">中文支持</h2>
<ul>
<li><a href="http://www.coreseek.cn/">Coreseek</a></li>
<li><a href="http://sphinxsearchcn.github.io/">sphinx-for-chinese</a> 注意：这里的 sphinx-for-chinese 是基于 sphinx 2.2.1 版的，如果需要 Golang 客户端操作 SphinxQL 语句，根据 Go 的 <a href="https://github.com/go-sql-driver/mysql">mysql</a> 说明，至少要求 Sphinx(2.2.3) 以上版本。我尝试了下，的确不能操作成功，改用这个<a href="https://github.com/eric1688/sphinx">较新的版本</a>后才解决 Go 客户端操作 SphinxQL 的问题。</li>
</ul>
<h2 id="api">API 协议</h2>
<p>Sphinx 源码已经提供了 Python，Ruby，PHP，Java，C 这几种语言的 API 包了，如需实现其他语言的 API 包，就要分析 Sphinx API 协议了。具体可以通过 Python 的客户端 <code>sphinx-x.x.x/api/sphinxapi.py</code> 分析。下面分析一个 wireshark 抓取的 Sphinx 请求包:</p>
<h3 id="_5">请求</h3>
<p>发出一个检索 "hello" 的请求，返回数量限制(limit)为 20。</p>
<p>DATA 内容:</p>
<div class="hlcode"><pre><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">14</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span>
<span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">06</span><span class="o">:</span><span class="mi">68</span><span class="o">:</span><span class="mi">65</span><span class="o">:</span><span class="mi">6</span><span class="n">c</span><span class="o">:</span><span class="mi">6</span><span class="n">c</span><span class="o">:</span><span class="mi">6</span><span class="n">f</span><span class="o">:</span><span class="mi">20</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">02</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">64</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">01</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span>
<span class="mi">00</span><span class="o">:</span><span class="mi">01</span><span class="o">:</span><span class="mi">2</span><span class="n">a</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">01</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span>
<span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">03</span><span class="o">:</span><span class="n">e8</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">0</span><span class="n">b</span><span class="o">:</span><span class="mi">40</span><span class="o">:</span><span class="mi">67</span><span class="o">:</span><span class="mi">72</span><span class="o">:</span><span class="mi">6</span><span class="n">f</span><span class="o">:</span><span class="mi">75</span><span class="o">:</span>
<span class="mi">70</span><span class="o">:</span><span class="mi">20</span><span class="o">:</span><span class="mi">64</span><span class="o">:</span><span class="mi">65</span><span class="o">:</span><span class="mi">73</span><span class="o">:</span><span class="mi">63</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span>
<span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span>
<span class="mi">00</span><span class="o">:</span><span class="mi">01</span><span class="o">:</span><span class="mi">2</span><span class="n">a</span>
</pre></div>


<p>对应的结构：</p>
<div class="hlcode"><pre><span class="n">offset</span><span class="o">:</span>         <span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span>
<span class="n">limit</span><span class="o">:</span>          <span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">14</span><span class="o">:</span>
<span class="n">mode</span><span class="o">:</span>           <span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span>
<span class="n">ranker</span><span class="o">:</span>         <span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span>
<span class="n">sortMode</span><span class="o">:</span>   <span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span>
<span class="n">sortByLen</span><span class="o">:</span>  <span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span>
<span class="n">queryLen</span><span class="o">:</span>   <span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">06</span><span class="o">:</span>
<span class="n">query</span><span class="o">:</span>          <span class="mi">68</span><span class="o">:</span><span class="mi">65</span><span class="o">:</span><span class="mi">6</span><span class="n">c</span><span class="o">:</span><span class="mi">6</span><span class="n">c</span><span class="o">:</span><span class="mi">6</span><span class="n">f</span><span class="o">:</span><span class="mi">20</span><span class="o">:</span> <span class="o">(</span><span class="n">hello</span> <span class="o">)</span>
<span class="n">weightsLen</span><span class="o">:</span> <span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">02</span><span class="o">:</span>
<span class="n">weights</span><span class="o">:</span>    <span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">64</span><span class="o">:</span>
<span class="n">weights</span><span class="o">:</span>    <span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">01</span><span class="o">:</span>
<span class="n">indexLen</span><span class="o">:</span>   <span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">01</span><span class="o">:</span>
<span class="n">index</span><span class="o">:</span>          <span class="mi">2</span><span class="n">a</span><span class="o">:</span> <span class="o">(*)</span>
<span class="n">id64</span> <span class="n">range</span> <span class="n">marker</span><span class="o">:</span>  <span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">01</span><span class="o">:</span>
<span class="n">minID</span><span class="o">:</span>          <span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span>
<span class="n">maxID</span><span class="o">:</span>          <span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span>
<span class="n">filters</span> <span class="n">len</span><span class="o">:</span>    <span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span>
<span class="n">groupFunc</span><span class="o">:</span>  <span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span>
<span class="n">groupBy</span> <span class="n">len</span><span class="o">:</span>    <span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span>
<span class="n">maxMatches</span><span class="o">:</span> <span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">03</span><span class="o">:</span><span class="n">e8</span><span class="o">:</span> <span class="o">(</span><span class="mi">1000</span><span class="o">)</span>
<span class="n">groupSort</span> <span class="n">len</span><span class="o">:</span>  <span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">0</span><span class="n">b</span><span class="o">:</span>
<span class="n">groupSort</span><span class="o">:</span>  <span class="mi">40</span><span class="o">:</span><span class="mi">67</span><span class="o">:</span><span class="mi">72</span><span class="o">:</span><span class="mi">6</span><span class="n">f</span><span class="o">:</span><span class="mi">75</span><span class="o">:</span><span class="mi">70</span><span class="o">:</span><span class="mi">20</span><span class="o">:</span><span class="mi">64</span><span class="o">:</span><span class="mi">65</span><span class="o">:</span><span class="mi">73</span><span class="o">:</span><span class="mi">63</span><span class="o">:</span> <span class="o">(</span><span class="s2">&quot;@group desc&quot;</span><span class="o">)</span>
<span class="n">cutoff</span><span class="o">:</span>         <span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span>
<span class="n">retryCount</span><span class="o">:</span> <span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span>
<span class="n">retryDelay</span><span class="o">:</span> <span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span>
<span class="n">groupDistinct</span> <span class="n">len</span><span class="o">:</span>  <span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span>
<span class="n">anchor</span> <span class="n">point</span> <span class="n">flag</span><span class="o">:</span>  <span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span>
<span class="n">indexWeights</span> <span class="n">len</span><span class="o">:</span>   <span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span>
<span class="n">maxQueryTime</span><span class="o">:</span>   <span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span>
<span class="n">fieldWeights</span><span class="o">:</span>   <span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span>
<span class="n">comment</span> <span class="n">len</span><span class="o">:</span>    <span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span>
<span class="n">overrides</span> <span class="n">len</span><span class="o">:</span>  <span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span>
<span class="n">select</span> <span class="n">len</span><span class="o">:</span> <span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">01</span><span class="o">:</span>
<span class="n">select</span><span class="o">:</span>     <span class="mi">2</span><span class="n">a</span><span class="o">:</span> <span class="o">(</span><span class="s2">&quot;*&quot;</span><span class="o">)</span>
</pre></div>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2016 .
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2016-11-20 10:45:27</p>
      </span>
    </div>
  </body>
</html>